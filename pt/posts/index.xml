<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Posts on Blog | Breno5G</title><link>https://blog.breno5g.dev/pt/posts/</link><description>Recent content in Posts on Blog | Breno5G</description><generator>Hugo -- gohugo.io</generator><language>pt-BR</language><copyright>Breno Santos</copyright><lastBuildDate>Sun, 14 Dec 2025 18:00:34 -0300</lastBuildDate><atom:link href="https://blog.breno5g.dev/pt/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Plugin Para O KoReader</title><link>https://blog.breno5g.dev/pt/posts/plugin-para-o-koreader/</link><pubDate>Sun, 14 Dec 2025 18:00:34 -0300</pubDate><guid>https://blog.breno5g.dev/pt/posts/plugin-para-o-koreader/</guid><description>&lt;h1 id="o-problema">O problema&lt;/h1>
&lt;p>Recentemente decidi retomar meus estudos, tanto para evoluir na programação quanto para continuar meu desenvolvimento pessoal.&lt;br>
Alguns amigos me recomendaram livros de psicologia, filosofia e outros temas que despertaram meu interesse — e, claro, fui adicionando tudo ao meu Kindle.&lt;/p>
&lt;p>Minha ideia era simples: ler no Kindle, marcar os trechos importantes e enviar essas anotações automaticamente para meu &lt;strong>vault do Obsidian&lt;/strong>, onde centralizo meus estudos e notas. Assim eu poderia revisitar facilmente os conceitos mais marcantes de cada leitura.&lt;/p></description><content:encoded><![CDATA[<h1 id="o-problema">O problema</h1>
<p>Recentemente decidi retomar meus estudos, tanto para evoluir na programação quanto para continuar meu desenvolvimento pessoal.<br>
Alguns amigos me recomendaram livros de psicologia, filosofia e outros temas que despertaram meu interesse — e, claro, fui adicionando tudo ao meu Kindle.</p>
<p>Minha ideia era simples: ler no Kindle, marcar os trechos importantes e enviar essas anotações automaticamente para meu <strong>vault do Obsidian</strong>, onde centralizo meus estudos e notas. Assim eu poderia revisitar facilmente os conceitos mais marcantes de cada leitura.</p>
<p>Mas aí veio o problema.<br>
Meu plano era usar o <strong>Readwise</strong> para capturar os highlights e enviá-los para o Obsidian através de um plugin simples.<br>
Para minha ingrata surpresa, descobri que o Readwise <strong>não captura os destaques de livros adicionados manualmente ao Kindle</strong> — apenas os comprados na loja da Amazon.</p>
<p>E eu sabia que os highlights existiam, pois apareciam normalmente ao abrir o livro no aplicativo oficial.</p>
<h1 id="a-solução">A solução</h1>
<p>Eu poderia simplesmente desistir da automação e continuar copiando tudo manualmente.<br>
Ou poderia procurar alguma ferramenta de terceiros que resolvesse o problema.<br>
Mas decidi seguir outro caminho: <strong>abandonar de vez o ecossistema fechado da Amazon</strong>, desbloquear meu Kindle e criar minha própria solução.</p>
<p>Depois de algumas pesquisas sobre jailbreak, acabei encontrando um artigo sobre o <strong>KOReader</strong> — um leitor de documentos <em>open source</em> para dispositivos <em>e-ink</em>, com suporte a plugins e ampla personalização. Exatamente o que eu procurava.</p>
<p>Libertada a alma Kindle, instalei o KOReader e parti em busca de documentação sobre como desenvolver plugins.<br>
Mas, para minha surpresa, <strong>não havia nenhum “getting started”</strong> — nem mesmo uma barra de pesquisa para localizar funções na wiki.</p>
<p>Ou seja: se eu quisesse fazer isso funcionar, teria que explorar o código-fonte e aprender como os antigos faziam.</p>
<h1 id="o-plano-de-ação">O plano de ação</h1>
<p>Antes de partir para o estudo do código, resolvi definir os requisitos básicos de como esse plugin deve se comportar.</p>
<p>A ideia básica é que o plugin deve:</p>
<ul>
<li>Buscar os <strong>highlights</strong> do livro atualmente aberto;</li>
<li>Ler o conteúdo salvo;</li>
<li>Enviar para um <strong>servidor HTTP</strong> que deve lidar com isso de forma apropriada.</li>
</ul>
<p>Assim o plugin poderá se comunicar com qualquer servidor que tenha uma rota para lidar com isso.</p>
<p>Para a parte visual, precisamos de:</p>
<ul>
<li>Um <strong>formulário</strong> onde o usuário possa inserir o IP e a porta onde o servidor estará rodando;</li>
<li>Um <strong>botão</strong> para disparar o evento de sincronização;</li>
<li>E, claro, um <strong>botão de debug</strong>.</li>
</ul>
<h1 id="botando-a-mão-na-massa">Botando a mão na massa</h1>
<p>Como ponto de partida, escolhi dois plugins nativos do KOReader como base:</p>
<ul>
<li>O do <em>Calibre</em>, que me daria uma base de como exibir os componentes em tela;</li>
<li>E o <em>Exporter</em>, que é um plugin já pensado para lidar com os highlights.</li>
</ul>
<p>A primeira tarefa a ser feita era descobrir como iniciar o plugin e mostrar um singelo “Hello world” em tela — e, para isso, a estrutura abaixo foi necessária:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">local</span> <span class="n">InfoMessage</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;ui/widget/infomessage&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kd">local</span> <span class="n">UIManager</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;ui/uimanager&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kd">local</span> <span class="n">WidgetContainer</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;ui/widget/container/widgetcontainer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="kd">local</span> <span class="n">_</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;gettext&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="kd">local</span> <span class="n">ObsidianSync</span> <span class="o">=</span> <span class="n">WidgetContainer</span><span class="p">:</span><span class="n">extend</span><span class="p">({</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;obsidiansync&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="n">is_doc_only</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="kr">function</span> <span class="nc">ObsidianSync</span><span class="p">:</span><span class="nf">init</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="n">self.ui</span><span class="p">.</span><span class="n">menu</span><span class="p">:</span><span class="n">registerToMainMenu</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="kr">function</span> <span class="nc">ObsidianSync</span><span class="p">:</span><span class="nf">addToMainMenu</span><span class="p">(</span><span class="n">menu_items</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="n">menu_items.obsidiansync</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">		<span class="n">text</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&#34;Obsidian Sync&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">		<span class="n">sorting_hint</span> <span class="o">=</span> <span class="s2">&#34;tools&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">		<span class="n">sub_item_table</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">				<span class="n">text</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&#34;Export Highlights&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">				<span class="n">callback</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">					<span class="n">UIManager</span><span class="p">:</span><span class="n">show</span><span class="p">(</span><span class="n">InfoMessage</span><span class="p">:</span><span class="n">new</span><span class="p">({</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">						<span class="n">text</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&#34;Hello, plugin world&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">					<span class="p">}))</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">				<span class="kr">end</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">
</span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="kr">return</span> <span class="n">ObsidianSync</span></span></span></code></pre></div><p>Explicando por alto esse código:<br>
fizemos a inicialização de uma classe chamada <strong><code>ObsidianSync</code></strong>, que herda da classe <strong><code>WidgetContainer</code></strong> todos os métodos e atributos básicos para podermos criar um <em>plugin/widget</em> no KOReader.</p>
<p>Criamos também um método <strong><code>init</code></strong>, que será chamado na inicialização do app e será responsável por adicionar o plugin na interface.</p>
<p>Para finalizar, criamos o método <strong><code>addToMainMenu</code></strong> que, como o nome sugere, fica responsável por adicionar ao menu os elementos visuais do plugin.</p>
<h2 id="evento-para-capturar-informações-basicas">Evento para capturar informações basicas</h2>
<p>Após criarmos a estrutura básica do plugin, eu precisava descobrir como capturar as informações básicas do livro que estamos mexendo, coisas como título, quantidade de páginas, progresso de leitura e, não menos importante, os <strong>highlights</strong>.</p>
<p>​Então, para começarmos essa parte, resolvi criar um método de <strong><code>debug</code></strong> que nos retornasse as informações básicas de qual livro estamos, qual a extensão dele e em qual diretório ele está localizado.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kr">function</span> <span class="nc">ObsidianSync</span><span class="p">:</span><span class="nf">getFileNameAndExtension</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">	<span class="kd">local</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">		<span class="n">dirname</span> <span class="o">=</span> <span class="n">path</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&#34;(.+)/[^/]+$&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">		<span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&#34;([^/]+)%.&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">		<span class="n">extension</span> <span class="o">=</span> <span class="n">path</span><span class="p">:</span><span class="n">match</span><span class="p">(</span><span class="s2">&#34;%.([^%.]+)$&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="kr">return</span> <span class="n">info</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="kr">function</span> <span class="nc">ObsidianSync</span><span class="p">:</span><span class="nf">debug</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="kd">local</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="n">table.insert</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s2">&#34;====== DEBUG INFO ======&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="n">table.insert</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl">	<span class="kr">if</span> <span class="ow">not</span> <span class="n">self.ui</span><span class="p">.</span><span class="n">document</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">		<span class="n">table.insert</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s2">&#34;❌ Open a document to proced&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">		<span class="n">self</span><span class="p">:</span><span class="n">info</span><span class="p">(</span><span class="n">table.concat</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">		<span class="kr">return</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">	<span class="kr">end</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">
</span></span><span class="line"><span class="ln">23</span><span class="cl">	<span class="kd">local</span> <span class="n">fileInfo</span> <span class="o">=</span> <span class="n">self</span><span class="p">:</span><span class="n">getFileNameAndExtension</span><span class="p">(</span><span class="n">self.ui</span><span class="p">.</span><span class="n">document.file</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">	<span class="n">table.insert</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s2">&#34;✅ Document infos:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">	<span class="n">table.insert</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s2">&#34;- Dirname: &#34;</span> <span class="o">..</span> <span class="n">fileInfo.dirname</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">	<span class="n">table.insert</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s2">&#34;- Filename: &#34;</span> <span class="o">..</span> <span class="n">fileInfo.filename</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">	<span class="n">table.insert</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s2">&#34;- Extension: &#34;</span> <span class="o">..</span> <span class="n">fileInfo.extension</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl">	<span class="n">self</span><span class="p">:</span><span class="n">info</span><span class="p">(</span><span class="n">table.concat</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="kr">end</span></span></span></code></pre></div><p>Provavelmente, temos alguma abordagem mais simples para pegar os dados do livro, mas nada que um <code>regex</code> e certa força de vontade não resolvam.</p>
<h2 id="acessando-os-highlights">Acessando os highlights</h2>
<p>Agora que temos acesso às informações mais básicas do livro atual, precisamos descobrir onde o KoReader salva as informações que queremos do livro.</p>
<p>​Depois de alguns minutos de pesquisa e testes, acabei vendo que na mesma pasta onde o livro está salvo é gerada uma outra pasta chamada <em>filename.sdr</em>  e, nessa pasta, é criado um arquivo <em>metadata.{extensão do livro}.lua</em> que contém todas as informações básicas sobre o livro.</p>
<p>​Analisando o arquivo metadata, encontrei a chave <em>annotation</em> que contém todos os <strong>highlights</strong> e informações dele salvos.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kr">function</span> <span class="nc">ObsidianSync</span><span class="p">:</span><span class="nf">getSDRData</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">	<span class="kr">if</span> <span class="ow">not</span> <span class="n">self.ui</span><span class="p">.</span><span class="n">document</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">		<span class="n">self</span><span class="p">:</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;❌ Open a document to proced&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">		<span class="kr">return</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="kr">end</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="kd">local</span> <span class="n">fileInfo</span> <span class="o">=</span> <span class="n">self</span><span class="p">:</span><span class="n">getFileNameAndExtension</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="kd">local</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">		<span class="n">loadfile</span><span class="p">(</span><span class="n">fileInfo.dirname</span> <span class="o">..</span> <span class="s2">&#34;/&#34;</span> <span class="o">..</span> <span class="n">fileInfo.filename</span> <span class="o">..</span> <span class="s2">&#34;.sdr/metadata.&#34;</span> <span class="o">..</span> <span class="n">fileInfo.extension</span> <span class="o">..</span> <span class="s2">&#34;.lua&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="kr">if</span> <span class="ow">not</span> <span class="n">chunk</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">		<span class="n">self</span><span class="p">:</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;❌ Error to open sdr: &#34;</span> <span class="o">..</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">		<span class="kr">return</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="kr">end</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="kd">local</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="n">self</span><span class="p">:</span><span class="n">info</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&#34;annotations&#34;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&#34;text&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="kr">end</span></span></span></code></pre></div><h2 id="projetando-a-comunicação-com-o-servidor">Projetando a comunicação com o servidor</h2>
<p>Agora que temos os dados que precisamos, falta apenas conseguirmos nos comunicar com o servidor e enviar os arquivos.</p>
<p>​Pensei em N formas que poderíamos fazer essa conexão, mas resolvi focar primeiro no básico e depois incrementar, caso necessário. Então, para começar, precisamos apenas do <strong><code>IP</code></strong> da máquina onde o servidor estará rodando e da <strong><code>PORTA</code></strong> onde o serviço vai estar escutando.</p>
<p>​Antes de tentar a comunicação com o servidor, resolvi criar um arquivo de configuração básico para que o usuário possa preencher essas informações uma única vez e possa reutilizar nas próximas sessões de leitura.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">local</span> <span class="n">ObsidianSync</span> <span class="o">=</span> <span class="n">WidgetContainer</span><span class="p">:</span><span class="n">extend</span><span class="p">({</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">	<span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;obsidiansync&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">	<span class="n">is_doc_only</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">		<span class="n">address</span> <span class="o">=</span> <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">		<span class="n">port</span> <span class="o">=</span> <span class="mi">9090</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">		<span class="n">password</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="kr">function</span> <span class="nc">ObsidianSync</span><span class="p">:</span><span class="nf">configure</span><span class="p">(</span><span class="n">touchmenu_instance</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="kd">local</span> <span class="n">MultiInputDialog</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;ui/widget/multiinputdialog&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="kd">local</span> <span class="n">url_dialog</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="kd">local</span> <span class="n">current_settings</span> <span class="o">=</span> <span class="n">self.settings</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">		<span class="ow">or</span> <span class="n">G_reader_settings</span><span class="p">:</span><span class="n">readSetting</span><span class="p">(</span><span class="s2">&#34;obsidiansync_settings&#34;</span><span class="p">,</span> <span class="n">ObsidianSync.defaults</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl">	<span class="kd">local</span> <span class="n">obsidian_url_address</span> <span class="o">=</span> <span class="n">current_settings.address</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">	<span class="kd">local</span> <span class="n">obsidian_url_port</span> <span class="o">=</span> <span class="n">current_settings.port</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">	<span class="n">url_dialog</span> <span class="o">=</span> <span class="n">MultiInputDialog</span><span class="p">:</span><span class="n">new</span><span class="p">({</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">		<span class="n">title</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&#34;Set custom obsidian address&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">		<span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">				<span class="n">text</span> <span class="o">=</span> <span class="n">obsidian_url_address</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">				<span class="n">input_type</span> <span class="o">=</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">				<span class="n">hint</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&#34;IP Address&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">				<span class="n">text</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">obsidian_url_port</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">				<span class="n">input_type</span> <span class="o">=</span> <span class="s2">&#34;number&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">				<span class="n">hint</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&#34;Port&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">		<span class="n">buttons</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">					<span class="n">text</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&#34;Cancel&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">					<span class="n">id</span> <span class="o">=</span> <span class="s2">&#34;close&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">					<span class="n">callback</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">						<span class="n">UIManager</span><span class="p">:</span><span class="n">close</span><span class="p">(</span><span class="n">url_dialog</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">					<span class="kr">end</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">				<span class="p">},</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">					<span class="n">text</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&#34;OK&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">					<span class="n">callback</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">						<span class="kd">local</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">url_dialog</span><span class="p">:</span><span class="n">getFields</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">						<span class="kr">if</span> <span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">~=</span> <span class="s2">&#34;&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">							<span class="kd">local</span> <span class="n">port</span> <span class="o">=</span> <span class="n">tonumber</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">							<span class="kr">if</span> <span class="ow">not</span> <span class="n">port</span> <span class="ow">or</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">port</span> <span class="o">&gt;</span> <span class="mi">65355</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">								<span class="n">port</span> <span class="o">=</span> <span class="n">ObsidianSync.defaults</span><span class="p">.</span><span class="n">port</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">							<span class="kr">end</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">
</span></span><span class="line"><span class="ln">55</span><span class="cl">							<span class="c1">-- Preserva o device_id existente ao salvar</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">							<span class="kd">local</span> <span class="n">new_settings</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">								<span class="n">address</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">								<span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">								<span class="n">device_id</span> <span class="o">=</span> <span class="n">self.settings</span><span class="p">.</span><span class="n">device_id</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">							<span class="p">}</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">							<span class="n">G_reader_settings</span><span class="p">:</span><span class="n">saveSetting</span><span class="p">(</span><span class="s2">&#34;obsidiansync_settings&#34;</span><span class="p">,</span> <span class="n">new_settings</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl">							<span class="n">self.settings</span> <span class="o">=</span> <span class="n">new_settings</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">							<span class="n">self</span><span class="p">:</span><span class="n">showNotification</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&#34;✅ Settings saved!&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">						<span class="kr">end</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">						<span class="n">UIManager</span><span class="p">:</span><span class="n">close</span><span class="p">(</span><span class="n">url_dialog</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">						<span class="kr">if</span> <span class="n">touchmenu_instance</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">							<span class="n">touchmenu_instance</span><span class="p">:</span><span class="n">updateItems</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl">						<span class="kr">end</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl">					<span class="kr">end</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl">				<span class="p">},</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="ln">72</span><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="ln">73</span><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="ln">74</span><span class="cl">	<span class="n">UIManager</span><span class="p">:</span><span class="n">show</span><span class="p">(</span><span class="n">url_dialog</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">75</span><span class="cl">	<span class="n">url_dialog</span><span class="p">:</span><span class="n">onShowKeyboard</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">76</span><span class="cl"><span class="kr">end</span></span></span></code></pre></div><p>Esse método fica responsável por criar os inputs e salvar os dados preenchidos pelo usuário num arquivo de configuração que permanece independente do livro ou sessão atual.</p>
<p>​Agora que temos os dados de para onde enviar os arquivos, podemos apenas pegar o metadata e enviá-lo para o servidor — o metadata é basicamente um objeto (table) e iremos deixar o servidor lidar com os dados que ele quer ou não.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kr">function</span> <span class="nc">ObsidianSync</span><span class="p">:</span><span class="nf">sendToServer</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">	<span class="kd">local</span> <span class="n">json</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&#34;json&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="kd">local</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">self</span><span class="p">:</span><span class="n">getSDRData</span><span class="p">()</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="kr">if</span> <span class="ow">not</span> <span class="n">metadata</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">		<span class="kr">return</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="kr">end</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="kd">local</span> <span class="n">body</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">json.encode</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="kr">if</span> <span class="ow">not</span> <span class="n">body</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">		<span class="n">self</span><span class="p">:</span><span class="n">showNotification</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&#34;❌ Error encoding JSON: &#34;</span><span class="p">)</span> <span class="o">..</span> <span class="p">(</span><span class="n">err</span> <span class="ow">or</span> <span class="n">_</span><span class="p">(</span><span class="s2">&#34;unknown&#34;</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">		<span class="kr">return</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="kr">end</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="kd">local</span> <span class="n">device_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">:</span><span class="n">getDeviceID</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="kr">if</span> <span class="ow">not</span> <span class="n">device_id</span> <span class="ow">or</span> <span class="n">device_id</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">		<span class="n">self</span><span class="p">:</span><span class="n">showNotification</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&#34;❌ Error: Could not get device ID.&#34;</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">		<span class="kr">return</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">	<span class="kr">end</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">	<span class="kd">local</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">self.settings</span> <span class="ow">or</span> <span class="n">G_reader_settings</span><span class="p">:</span><span class="n">readSetting</span><span class="p">(</span><span class="s2">&#34;obsidiansync_settings&#34;</span><span class="p">,</span> <span class="n">ObsidianSync.defaults</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">	<span class="kd">local</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://&#34;</span> <span class="o">..</span> <span class="n">settings.address</span> <span class="o">..</span> <span class="s2">&#34;:&#34;</span> <span class="o">..</span> <span class="n">settings.port</span> <span class="o">..</span> <span class="s2">&#34;/sync&#34;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl">	<span class="n">self</span><span class="p">:</span><span class="n">showNotification</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&#34;Syncing with server...&#34;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">	<span class="n">UIManager</span><span class="p">:</span><span class="n">scheduleIn</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="kr">function</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">		<span class="n">self</span><span class="p">:</span><span class="n">_doSyncRequest</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">device_id</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">	<span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="kr">end</span></span></span></code></pre></div><p>Aqui pegamos todo o <em>metadata</em> e, com as configurações salvas do usuário, nos comunicamos com o servidor na rota <strong><code>/sync</code></strong> para finalizarmos a <strong>sincronização dos</strong> <em><strong>highlights</strong></em>.</p>
<h1 id="conclusão">Conclusão</h1>
<p>Chegamos ao final do desenvolvimento do <em>plugin</em> (ao menos a parte do KoReader) e o código completo está disponível no meu <em>github</em> no repositório <a href="https://github.com/breno5g/koreadersync.koplugin">koreadersync.koplugin</a>.</p>
]]></content:encoded></item></channel></rss>